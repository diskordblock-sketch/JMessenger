<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Настройки - JMessenger</title>
    <style>
        body {
            margin: 0; height: 100vh; display: flex; align-items: center; justify-content: center;
            background: radial-gradient(circle at center, #2a1a4a 0%, #0f1721 100%);
            font-family: sans-serif; color: white; padding: 20px; box-sizing: border-box;
        }
        .card {
            background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(25px);
            padding: 30px; border-radius: 32px; border: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%; max-width: 350px; text-align: center; box-shadow: 0 25px 50px rgba(0,0,0,0.6);
        }
        .avatar { width: 80px; height: 80px; background: linear-gradient(135deg, #6a11cb, #2575fc); border-radius: 50%; margin: 0 auto 15px; display: flex; align-items: center; justify-content: center; font-size: 32px; font-weight: bold; }
        input { width: 100%; padding: 14px; margin: 8px 0; border-radius: 12px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); color: white; box-sizing: border-box; outline: none; }
        .btn { width: 100%; padding: 14px; background: linear-gradient(135deg, #6a11cb, #2575fc); border: none; border-radius: 12px; color: white; font-weight: bold; cursor: pointer; margin-top: 10px; }
        .back { margin-top: 20px; display: block; color: #708499; text-decoration: none; font-size: 14px; }
        
        @media (max-width: 400px) {
            .card { padding: 20px; }
        }
    </style>
</head>
<body>
    <div class="card">
        <div class="avatar" id="av">?</div>
        <h2 id="curN" style="margin-bottom: 20px;">Профиль</h2>
        <input type="text" id="nInp" placeholder="Новое имя">
        <input type="text" id="uInp" placeholder="Новый @username">
        <button class="btn" onclick="update()">СОХРАНИТЬ</button>
        <button class="btn" style="background:#e53935; margin-top:10px" onclick="logout()">ВЫЙТИ</button>
        <a href="second.html" class="back">← Назад к чатам</a>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyA9X5comyXJzgrsv_KZtoHbkXUoViCbUJM",
            authDomain: "messeg-2b14a.firebaseapp.com",
            projectId: "messeg-2b14a",
            storageBucket: "messeg-2b14a.firebasestorage.app",
            messagingSenderId: "505847795650",
            appId: "1:505847795650:web:04833b23cc1f8be018d05b"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        onAuthStateChanged(auth, async (u) => {
            if (u) {
                const d = await getDoc(doc(db, "users", u.uid));
                if (d.exists()) {
                    document.getElementById('nInp').value = d.data().displayName;
                    document.getElementById('uInp').value = d.data().username;
                    document.getElementById('curN').innerText = d.data().displayName;
                    document.getElementById('av').innerText = d.data().displayName[0].toUpperCase();
                }
            } else { location.href = "index.html"; }
        });

        window.update = async () => {
            const n = document.getElementById('nInp').value;
            const u = document.getElementById('uInp').value;
            if(!n || !u) return alert("Заполните поля!");
            try {
                await updateDoc(doc(db, "users", auth.currentUser.uid), { displayName: n, username: u });
                alert("Обновлено!");
                location.reload();
            } catch(e) { alert(e.message); }
        };

        window.logout = async () => {
            try { await signOut(auth); location.href = "index.html"; } catch (e) { alert(e.message); }
        };
    </script>
</body>
</html>
